<!DOCTYPE html>
<html lang="en">
<title>futureplanet.eco</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" as="font" href="https://fonts.googleapis.com/css?family=Roboto&display=swap">
<style>
  body,
  html {
    font-family: '"Roboto", sans-serif';
    height: 100%;
    /* background-color: #222c3c; */
    color: #bfb5af;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
<script src="js/redis-values2.js"></script>

<body>
  <div id="pngPlaceHolder"></div>
  <!-- Plot Corona Deaths 3 Charts -->
  <div id="plotCorona">
  </div>

  <script>

    Chart.defaults.global.defaultFontFamily = "'Roboto', sans-serif";
    Chart.defaults.global.defaultFontSize = 16;
    Chart.defaults.global.elements.point.radius = 0;
    Chart.defaults.global.elements.line.borderWidth = 2;
    Chart.defaults.global.animation.duration = 0;
    Chart.defaults.scale.gridLines.drawOnChartArea = true;
    Chart.defaults.global.defaultFontColor = '#bebcb7';
    const leftColor = 'rgba(220,119,21,0.9)';
    const rightColor = 'rgba(193,199,191,0.45)';

    Chart.defaults.global.animation.onComplete = (e) => onCompleteCallback(e.chart);

    function onCompleteCallback(id) {
      let div = document.getElementById("pngPlaceHolder");
      let img = document.createElement("IMG");
      img.style.backgroundColor = "#222c3c"
      img.className = "fp-image";
      img.id = 'covid-' + id.canvas.id;
      /*
            let ctx = document.getElementById(id.canvas.id).getContext('2d');
            console.log(ctx)
            ctx.font = "40px Roboto"
            ctx.fontWeight = 900
            ctx.fillStyle = "#eeeeee"
            ctx.textAlign = 'left'
            ctx.fillText(id.canvas.id, 16, 40)
            ctx.textAlign = 'right'
            ctx.fillStyle = "#bbbbbb"
            ctx.fillText(' deaths', document.getElementById(id.canvas.id).width - 16, 40)
      */
      img.src = id.toBase64Image();
      div.appendChild(img);
    }

    console.log(redisCovidDeathsSummary.data.length)
    redisCovidDeathsSummary.data.forEach(r => {
      let filename = r.country.replace(/[^a-z]/gi, "_");
      console.log(filename);

      // Create a DIV to hold the CANVAS
      let chartDiv = document.createElement('DIV');
      // Append the DIV to the DOM
      document.getElementById('plotCorona').appendChild(chartDiv);
      // Create a CANVAS inside the chartDiv, the ID is unique and will be used as filename when saving PNG
      chartDiv.innerHTML = '<canvas class="ch" id="' + filename + '"></canvas>'
      // Now get the second dataset with the same COUNTRY 
      let c = redisCovidConfirmedSummary.data.find(x => x.country == r.country);

      new Chart(chartDiv.firstChild, {
        type: 'bar',
        data: {
          datasets: [
            datasetDeaths(r),
            datasetCases(c)
          ]
        },
        options: {
          tooltips: {
            enabled: false
          },
          legend: {
            labels: {
              boxWidth: 16
            }
          },
          title: {
            display: true,
            fontSize: 40,
            fontColor: '#eee',
            position: 'top',
            text: r.country
          },
          aspectRatio: 1.5,
          scales: {
            xAxes: [{
              scaleLabel: {
                display: true,
                fontColor: "#eee",
                labelString: 'Number of dead as of ' + moment(redisCovidDeathsSummary.accessed).format('dddd MMM D') + ': ' + r.total
              },
              gridLines: {
                display: false
              },
              offset: true,
              type: 'time',
              time: {
                unit: 'month',
                displayFormats: {
                  month: 'MMM'
                }
              }
            }],
            yAxes: [{
              id: 'L',
              position: 'left',
              gridLines: {
                display: false
              },
              ticks: {
                suggestedMax: 100,
                min: 0,
                fontColor: leftColor
              }
            }, {
              id: 'R',
              position: 'right',
              gridLines: {
                display: false
              },
              ticks: {
                suggestedMax: 50,
                min: 0,
                color: rightColor
              },
            }]
          }
        }
      });

    });



    function datasetDeaths(r) {
      if (r === undefined) return;
      let r14 = [];
      for (let i = 0; i < r.data.length; i++) {
        // extract only relevant data for most recent 7 days
        let d = r.data.map(d => ({
          t: d.t,
          y: d.d
        })).slice(i - 7, i);
        // get rate per 100.000 pop
        r14.push({
          t: r.data[i].t,
          y: d.reduce((total, num) => total + num.y, 0) / 7
        })
      }
      return {
        yAxisID: 'L',
        label: 'Deaths per day',
        type: 'line',
        fill: false,
        borderColor: leftColor,
        data: r14
      };
    }

    function datasetCases(r) {
      if (r === undefined) return;
      let r14 = [];
      for (let i = 0; i < r.data.length; i += 1) {
        // extract only relevant data for most recent 14 days
        let d = r.data.map(d => ({
          t: d.t,
          y: d.d
        })).slice(i - 14, i);
        // get rate per 100.000 pop
        r14.push({
          t: r.data[i].t,
          y: d.reduce((total, num) => total + num.y, 0) / r.population / 10
        })
      }
      return {
        yAxisID: 'R',
        label: 'New cases last 14 days',
        borderWidth: 0,
        backgroundColor: rightColor,
        borderColor: rightColor,
        data: r14
      };
    }

  </script>

</body>

</html>